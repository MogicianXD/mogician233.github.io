<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mogician zlf">
  <!-- Open Graph Data -->
  <meta property="og:title" content="数据科学导论实验_爬虫"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="Mogician的个人小站"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="Mogician的个人小站" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Mogician的个人小站</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">数据科学导论实验_爬虫</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>" target="_blank" rel="noopener">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>" target="_blank" rel="noopener">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Mogician zlf</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2020-01-02</span>
            <span class="time">20:19:15</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="数据科学家的第一个Project"><a href="#数据科学家的第一个Project" class="headerlink" title="数据科学家的第一个Project"></a>数据科学家的第一个Project</h1><blockquote>
<p>* 图片存在github图床上，请在可以连通github的网络环境中阅读，以免图片预览失效</p>
</blockquote>
<h1 id="爬虫部分"><a href="#爬虫部分" class="headerlink" title="爬虫部分"></a>爬虫部分</h1><h2 id="爬取结果"><a href="#爬取结果" class="headerlink" title="爬取结果"></a>爬取结果</h2><p>一共爬取356万知乎用户，222万个回答，120万个问题，</p>
<p>其中，用户和用户回答分别爬取<br>（用户和回答api调用一次获取20个，但问题只能一次得一个，相同时间得到的问题要少很多）</p>
<table>
<thead>
<tr>
<th align="center">数据类型</th>
<th align="center">条数</th>
<th align="center">文件大小</th>
</tr>
</thead>
<tbody><tr>
<td align="center">用户</td>
<td align="center">3,555,056</td>
<td align="center">1180.844MB</td>
</tr>
<tr>
<td align="center">回答</td>
<td align="center">2,219,886</td>
<td align="center">448.313MB</td>
</tr>
<tr>
<td align="center">用户关注</td>
<td align="center">5,215,201</td>
<td align="center">1351.875MB</td>
</tr>
<tr>
<td align="center">话题关注</td>
<td align="center">12,097,062</td>
<td align="center">1765.984MB</td>
</tr>
<tr>
<td align="center">问题</td>
<td align="center">1,195,172</td>
<td align="center">191.766MB</td>
</tr>
<tr>
<td align="center">话题</td>
<td align="center">84,252</td>
<td align="center">6.516MB</td>
</tr>
</tbody></table>
<h2 id="对抗反爬虫"><a href="#对抗反爬虫" class="headerlink" title="对抗反爬虫"></a>对抗反爬虫</h2><ul>
<li>使用代理池，几百个代理轮转使用，防止IP被封</li>
<li>伪造User-Agent，随机选择fake_useragent库提供的ua和requests_html自带的ua</li>
<li>headers加入referer，更加逼真</li>
<li>尽可能使用知乎api取数据，而不通过html解析获取文本，加快速度，另外模仿正常人分页查询</li>
<li>存在要求登录才能查看的情况，于是实现了自动登录</li>
<li>使用CNN，自动识别英文验证码，验证通过unhuman检测</li>
</ul>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>24h不停歇爬取，放心挂机</li>
<li>最终爬到的数据量巨大，应该超过绝大多数同学</li>
</ul>
<h2 id="抓包分析知乎api"><a href="#抓包分析知乎api" class="headerlink" title="抓包分析知乎api"></a>抓包分析知乎api</h2><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209132655.png" style="zoom: 67%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">关注ta的：followers_api = <span class="string">"https://www.zhihu.com/api/v4/members/&#123;&#125;/followers?include=data%5B*%5D.answer_count%2Carticles_count%2Cgender%2Cfollower_count%2Cis_followed%2Cis_following%2Cbadge%5B%3F(type%3Dbest_answerer)%5D.topics\u0026offset=&#123;&#125;\u0026limit=20"</span>.format(url_token, offset)</span><br><span class="line"></span><br><span class="line">ta的关注：followees_api = <span class="string">"https://www.zhihu.com/api/v4/members/&#123;&#125;/followees?include=data%5B*%5D.answer_count%2Carticles_count%2Cgender%2Cfollower_count%2Cis_followed%2Cis_following%2Cbadge%5B%3F(type%3Dbest_answerer)%5D.topics\u0026offset=&#123;&#125;\u0026limit=20"</span>.format(url_token, offset)</span><br><span class="line"></span><br><span class="line">关注的话题：follow_topic_api = <span class="string">"https://www.zhihu.com/api/v4/members/&#123;&#125;/following-topic-contributions?include=data%5B*%5D.topic.introduction&amp;offset=&#123;&#125;&amp;limit=20"</span>.format(url_token, offset)</span><br><span class="line"></span><br><span class="line">回答：answer_api = <span class="string">'https://www.zhihu.com/api/v4/members/&#123;&#125;/answers?include=data%5B*%5D.comment_count%2Cvoteup_count%2Ccreated_time&amp;offset=&#123;&#125;&amp;limit=20&amp;sort_by=created'</span>.format(url_token, offset)</span><br><span class="line"></span><br><span class="line">问题：question_api = <span class="string">'https://www.zhihu.com/api/v4/questions/&#123;&#125;?include=data%5B*%5D.answer_count%2Cfollower_count'</span>.format(qid)</span><br></pre></td></tr></table></figure>

<p>虽然有些提交参数是我们用不到的信息，但经过测试，加入后似乎更不容易被检测到，尤其是limit，不分页很容易被检测到异常</p>
<p>另外，问题的api params没法通过抓包看到，最开始我是html解析，css选择器找的；后来一个一个试参数试出来了适合的api</p>
<p>爬取的思想是，找一个关注者较多的用户作为seed，数据库里存入该用户的url_token，然后爬取他的关注者和关注，从而获得user表数据</p>
<p>最开始我设计的递归爬取（深度优先），然而递归次数过多超过最大递归次数会抛出异常，因此改成迭代爬取（广度优先），将待爬取的送入数据库（不然太耗费内存）以待以后继续</p>
<p>因为封装比较多，具体爬取参见zhihu_spider.py</p>
<p>数据库用pymysql库读写，封装在db.py</p>
<h2 id="代理池"><a href="#代理池" class="headerlink" title="代理池"></a>代理池</h2><h3 id="爬取西刺上的免费代理"><a href="#爬取西刺上的免费代理" class="headerlink" title="爬取西刺上的免费代理"></a>爬取西刺上的免费代理</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent</span><br><span class="line"></span><br><span class="line">pagenum = <span class="number">4</span></span><br><span class="line">ua = UserAgent()</span><br><span class="line">encoding = <span class="string">'utf-8'</span></span><br><span class="line">s = requests.session()</span><br><span class="line">s.keep_alive = <span class="literal">False</span></span><br><span class="line">http_list = []</span><br><span class="line">https_list = []</span><br><span class="line">root = <span class="string">'https://www.xicidaili.com/nn/'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(pagenum):</span><br><span class="line">    r = s.get(root + str(pagenum+<span class="number">1</span>), headers=&#123;<span class="string">'User-Agent'</span>: ua.random&#125;)</span><br><span class="line">    r.encoding = encoding</span><br><span class="line">    soup = BeautifulSoup(r.text, <span class="string">'html.parser'</span>)</span><br><span class="line">    table = soup.find(<span class="string">'table'</span>, &#123;<span class="string">'id'</span>: <span class="string">'ip_list'</span>&#125;)</span><br><span class="line">    <span class="keyword">for</span> tr <span class="keyword">in</span> table.find_all(<span class="string">'tr'</span>)[<span class="number">1</span>:]:</span><br><span class="line">        tds = tr.find_all(<span class="string">'td'</span>)</span><br><span class="line">        <span class="keyword">if</span> tds:</span><br><span class="line">            ip = tds[<span class="number">1</span>].string</span><br><span class="line">            port = tds[<span class="number">2</span>].string</span><br><span class="line">            protocol = tds[<span class="number">5</span>].string</span><br><span class="line">            <span class="keyword">if</span> protocol == <span class="string">'HTTP'</span>:</span><br><span class="line">                http_list.append(<span class="string">'http://'</span> + ip + <span class="string">':'</span> + port)</span><br><span class="line">            <span class="keyword">elif</span> protocol == <span class="string">'HTTPS'</span>:</span><br><span class="line">                https_list.append(<span class="string">'https://'</span> + ip + <span class="string">':'</span> + port)</span><br></pre></td></tr></table></figure>

<p>质量不是很好，ip被封后大多很长时间内无法使用</p>
<h3 id="使用开源项目"><a href="#使用开源项目" class="headerlink" title="使用开源项目"></a>使用开源项目</h3><p>查找发现这个代理池不错 <a href="https://github.com/SpiderClub/haipproxy" target="_blank" rel="noopener">https://github.com/SpiderClub/haipproxy</a></p>
<p>在我的docker上pull一个镜像，开始server端；<br>再把原始项目clone下来，只保留client部分，运行即可；</p>
<p>此外，我改善了一些地方，改了一下代理调度的轮转方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> fake_useragent <span class="keyword">import</span> UserAgent</span><br><span class="line"><span class="keyword">from</span> client <span class="keyword">import</span> ProxyFetcher</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">proxy = <span class="literal">None</span></span><br><span class="line">retries = <span class="number">5</span></span><br><span class="line">tries = <span class="number">0</span></span><br><span class="line">fetcher = ProxyFetcher(<span class="string">'zhihu'</span>, strategy=<span class="string">'robin'</span>, length=<span class="number">5</span>)</span><br><span class="line"><span class="keyword">while</span> tries &lt; retries:</span><br><span class="line">    proxy = self.fetcher.get_proxy()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> proxy:</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        proxy = fetcher.get_proxy()</span><br><span class="line">    proxy = &#123;<span class="string">'http'</span>: proxy&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自动登录"><a href="#自动登录" class="headerlink" title="自动登录"></a>自动登录</h2><p>找了几个项目，很多都过时了，只有这个最好<br><a href="https://github.com/zkqiang/zhihu-login" target="_blank" rel="noopener">https://github.com/zkqiang/zhihu-login</a><br>因为有js执行部分，需要配置好npm、nodejs</p>
<p>但是它的验证码是手动输入的，需要改成自动输入验证码</p>
<h2 id="OCR识别验证码"><a href="#OCR识别验证码" class="headerlink" title="OCR识别验证码"></a>OCR识别验证码</h2><p>首先尝试使用tesseract-OCR，但在知乎验证码上效果很差</p>
<p>常见的做法可能是用验证码识别服务商的api，但是莫得钱</p>
<p>所以考虑神经网络识别，搭一个CNN很简单，<br>但是知乎验证码数据集难获取，需要一个一个人工标注</p>
<p>找了找发现了这个项目<br><a href="https://github.com/littlepai/Unofficial-Zhihu-API" target="_blank" rel="noopener">https://github.com/littlepai/Unofficial-Zhihu-API</a><br>用他的模型恢复参数，然后送入图片即可</p>
<p>知乎的验证码是base64 uri，以data:image/png;base64,开头，<br>后面是图片的base64编码，注意爬到的中间带有换行符，需要删掉再解码</p>
<p>自动登录时验证码通过 <a href="https://www.zhihu.com/api/v3/oauth/captcha?lang=en" target="_blank" rel="noopener">https://www.zhihu.com/api/v3/oauth/captcha?lang=en</a><br>获得（中文的需要用zheye，但没必要，识别英文足够了）</p>
<p>爬的数据量过多时，会出现unhuman验证，<br><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209133209.png" style="zoom: 50%;" /></p>
<p>最开始我是用requests-html渲染了页面，然后输入和点击</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> requests_html <span class="keyword">import</span> HTMLSession</span><br><span class="line"><span class="keyword">from</span> zhihu_captcha <span class="keyword">import</span> zhihu_captcha</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">'accept-language'</span>: <span class="string">'zh-CN,zh;q=0.9'</span>,</span><br><span class="line">           <span class="string">'Host'</span>: <span class="string">'www.zhihu.com'</span>,</span><br><span class="line">            <span class="string">'Upgrade-Insecure-Requests'</span>: <span class="string">'1'</span>,</span><br><span class="line">           <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36'</span></span><br><span class="line">           &#125;</span><br><span class="line">session = HTMLSession()</span><br><span class="line">captcha_model = zhihu_captcha.ZhihuCaptcha(<span class="string">'13641535335'</span>, <span class="string">'*******'</span>)</span><br><span class="line">appealUrl = <span class="string">'https://www.zhihu.com/account/unhuman?type=unhuman&amp;message=%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%B5%8B%E5%88%B0%E6%82%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E5%AD%98%E5%9C%A8%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%B8%BA%E4%BF%9D%E8%AF%81%E6%82%A8%E7%9A%84%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE%EF%BC%8C%E8%AF%B7%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81%E7%A0%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%E3%80%82&amp;need_login=false'</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'异常检测验证'</span>)</span><br><span class="line">r = session.get(appealUrl, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">r.html.render(keep_page=<span class="literal">True</span>, sleep=<span class="number">1</span>, wait=<span class="number">2</span>)</span><br><span class="line">captchaUrl = r.html.find(<span class="string">'img'</span>)[<span class="number">0</span>].attrs.get(<span class="string">'src'</span>)</span><br><span class="line">captchaUrl = re.sub(<span class="string">'\n'</span>, <span class="string">''</span>, captchaUrl)</span><br><span class="line">f = open(<span class="string">'cache/captcha2.gif'</span>, <span class="string">'wb'</span>)</span><br><span class="line">f.write(base64.b64decode(captchaUrl.strip(<span class="string">'data:image/png;base64,'</span>)))</span><br><span class="line">f.close()</span><br><span class="line">im = Image.open(<span class="string">'cache/captcha2.gif'</span>)</span><br><span class="line">im.save(<span class="string">'cache/captcha2.png'</span>)</span><br><span class="line">im = Image.open(<span class="string">'cache/captcha2.png'</span>)</span><br><span class="line">captcha = captcha_model.recgImg(im)</span><br><span class="line">print(captcha)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">await</span> r.html.page.type(<span class="string">'input'</span>, captcha)</span><br><span class="line">    <span class="keyword">await</span> r.html.page.click(<span class="string">'button'</span>)</span><br><span class="line">    <span class="keyword">await</span> r.html.page.close()</span><br><span class="line"></span><br><span class="line">session.loop.run_until_complete(run())</span><br></pre></td></tr></table></figure>

<p>过了一个月，写报告前试了一下，结果失败了；<br>看了一下是知乎改了机制，干脆研究一下api；<br>验证码的get和post的url都是<a href="https://www.zhihu.com/api/v4/anticrawl/captcha_appeal" target="_blank" rel="noopener">https://www.zhihu.com/api/v4/anticrawl/captcha_appeal</a><br><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209133336.png" style="zoom:67%;" /></p>
<p>需要注意post的时候headers里没有xsrf会请求失败，<br>而之前get的时候，session的cookie里保存了xsrf，那么设置cookie就可以</p>
<img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209133359.png" style="zoom:67%;" />


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">user_agent = <span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">appeal</span><span class="params">(self, url)</span>:</span></span><br><span class="line">    r = self.HTMLSession.get(<span class="string">'https://www.zhihu.com/api/v4/anticrawl/captcha_appeal'</span>)</span><br><span class="line">    captchaUrl = r.json()[<span class="string">'img_base64'</span>]</span><br><span class="line">    captchaUrl = re.sub(<span class="string">'\n'</span>, <span class="string">''</span>, captchaUrl)</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'cache/captcha2.gif'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        img_base64 = base64.b64decode(captchaUrl.strip(<span class="string">'data:image/png;base64,'</span>).strip())</span><br><span class="line">        print(img_base64)</span><br><span class="line">        f.write(img_base64)</span><br><span class="line">    im = Image.open(<span class="string">'cache/captcha2.gif'</span>)</span><br><span class="line">    im.save(<span class="string">'cache/captcha2.png'</span>)</span><br><span class="line">    im = Image.open(<span class="string">'cache/captcha2.png'</span>)</span><br><span class="line">    captcha = self.captcha_model.recgImg(im)</span><br><span class="line">    print(captcha)</span><br><span class="line"></span><br><span class="line">    r = self.HTMLSession.post(<span class="string">'https://www.zhihu.com/api/v4/anticrawl/captcha_appeal'</span>,</span><br><span class="line">                              data=json.dumps(&#123;<span class="string">"captcha"</span>: captcha&#125;),</span><br><span class="line">                              headers=&#123;<span class="string">"User-Agent"</span>: user_agent,</span><br><span class="line">                                       <span class="string">"referer"</span>: <span class="string">'https://www.zhihu.com/account/unhuman?type=unhuman&amp;message=%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%B5%8B%E5%88%B0%E6%82%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83%E5%AD%98%E5%9C%A8%E5%BC%82%E5%B8%B8%EF%BC%8C%E4%B8%BA%E4%BF%9D%E8%AF%81%E6%82%A8%E7%9A%84%E6%AD%A3%E5%B8%B8%E8%AE%BF%E9%97%AE%EF%BC%8C%E8%AF%B7%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81%E7%A0%81%E8%BF%9B%E8%A1%8C%E9%AA%8C%E8%AF%81%E3%80%82&amp;need_login=false'</span>,</span><br><span class="line">                                       <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">                                       <span class="string">'x-xsrftoken'</span>: self.HTMLSession.cookies._cookies[<span class="string">'.zhihu.com'</span>][<span class="string">'/'</span>][<span class="string">'_xsrf'</span>].value&#125;)</span><br><span class="line">    <span class="keyword">return</span> self.HTMLSession.get(url, allow_redirects=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h1 id="知乎数据分析"><a href="#知乎数据分析" class="headerlink" title="知乎数据分析"></a>知乎数据分析</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">from</span> db <span class="keyword">import</span> ZhihuDB</span><br><span class="line"><span class="keyword">import</span> jieba</span><br><span class="line"><span class="keyword">import</span> jieba.analyse</span><br><span class="line"><span class="keyword">import</span> jieba.posseg</span><br><span class="line"><span class="keyword">from</span> wordcloud <span class="keyword">import</span> WordCloud</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm_notebook</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> matplotlib.font_manager <span class="keyword">import</span> FontProperties</span><br><span class="line"></span><br><span class="line">db = ZhihuDB()</span><br></pre></td></tr></table></figure>

<h2 id="高频话题分析"><a href="#高频话题分析" class="headerlink" title="高频话题分析"></a>高频话题分析</h2><p>停用词</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stopwords = set([line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> open(<span class="string">'res/stopwords_zhihu.txt'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>).readlines()])</span><br></pre></td></tr></table></figure>

<p>查询所有问题的标题，并用jieba分词和词性标注，保留n名词、nr人名、ns地名对应的词语</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"""</span></span><br><span class="line"><span class="string">    SELECT title </span></span><br><span class="line"><span class="string">    FROM question </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">frequencies = dict()</span><br><span class="line"><span class="keyword">for</span> title <span class="keyword">in</span> tqdm_notebook(db.fetch_all(sql)):</span><br><span class="line">    <span class="comment"># text += ' '.join(set(jieba.cut(title[0])) - stopwords) + ' '</span></span><br><span class="line">    <span class="comment"># text += ' '.join(jieba.analyse.extract_tags(title[0], allowPOS=('n'))) + ' '</span></span><br><span class="line">    <span class="keyword">for</span> token <span class="keyword">in</span> jieba.posseg.cut(title[<span class="number">0</span>]):</span><br><span class="line">        <span class="keyword">if</span> token.flag[<span class="number">0</span>] != <span class="string">'n'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> token <span class="keyword">not</span> <span class="keyword">in</span> frequencies:</span><br><span class="line">            frequencies[token] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            frequencies[token] += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'cut_tmp.csv'</span>, <span class="string">'w+'</span>, encoding=<span class="string">'utf-8'</span>, newline=<span class="string">''</span>) <span class="keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f)</span><br><span class="line">    writer.writerow([<span class="string">'word'</span>, <span class="string">'flag'</span>, <span class="string">'freq'</span>])</span><br><span class="line">    <span class="keyword">for</span> token, freq <span class="keyword">in</span> frequencies.items():</span><br><span class="line">        writer.writerow([token.word, token.flag, freq])</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209133831.png" style="zoom:67%;" />

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">df_n = pd.read_csv(<span class="string">'cut_tmp.csv'</span>)</span><br><span class="line">df_n = df_n[~df_n[<span class="string">'word'</span>].isin(stopwords)]</span><br><span class="line">df_nr = df_n[df_n[<span class="string">'flag'</span>] == <span class="string">'nr'</span>]</span><br><span class="line">df_ns = df_n[df_n[<span class="string">'flag'</span>] == <span class="string">'ns'</span>]</span><br><span class="line">df_ns.head(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">word</th>
<th align="center">flag</th>
<th align="center">freq</th>
</tr>
</thead>
<tbody><tr>
<td align="center">13</td>
<td align="center">云</td>
<td align="center">ns</td>
<td align="center">1310</td>
</tr>
<tr>
<td align="center">23</td>
<td align="center">中国</td>
<td align="center">ns</td>
<td align="center">34620</td>
</tr>
<tr>
<td align="center">41</td>
<td align="center">入门</td>
<td align="center">ns</td>
<td align="center">1983</td>
</tr>
<tr>
<td align="center">76</td>
<td align="center">上海</td>
<td align="center">ns</td>
<td align="center">5318</td>
</tr>
</tbody></table>
<p>dataframe转字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dfs = &#123;<span class="string">'n'</span>: df_n, <span class="string">'nr'</span>: df_nr, <span class="string">'ns'</span>: df_ns&#125;</span><br><span class="line"><span class="comment"># texts = &#123;'n': '', 'nr': '', 'ns': ''&#125;</span></span><br><span class="line">dicts = &#123;<span class="string">'n'</span>: dict(), <span class="string">'nr'</span>: dict(), <span class="string">'ns'</span>: dict()&#125;</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> dfs.keys():</span><br><span class="line">    dfs[key] = dfs[key][[<span class="string">'word'</span>, <span class="string">'freq'</span>]].groupby(<span class="string">'word'</span>).sum()</span><br><span class="line">    dicts[key] = dict([(index, freq) <span class="keyword">for</span> index, freq <span class="keyword">in</span> zip(dfs[key].index, dfs[key].freq)])</span><br></pre></td></tr></table></figure>

<p>生成词云</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">font = <span class="string">'res/canger02_W03.ttf'</span></span><br><span class="line">mask = np.array(Image.open(<span class="string">'res/刘看山.png'</span>))</span><br><span class="line">wc = WordCloud(</span><br><span class="line">    background_color=<span class="string">'white'</span>,</span><br><span class="line">    mask=mask,  <span class="comment"># 若没有该项，则生成默认图片</span></span><br><span class="line">    font_path=font,  <span class="comment"># 中文分词必须有中文字体设置</span></span><br><span class="line">    stopwords=stopwords</span><br><span class="line">)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> dicts.keys():</span><br><span class="line">    wc.generate_from_frequencies(dicts[key])  <span class="comment"># 绘制图片</span></span><br><span class="line">    wc.to_file(<span class="string">'output/qu_wordcloud_'</span> + key + <span class="string">'.png'</span>)  <span class="comment"># 保存图片</span></span><br><span class="line"><span class="comment">#     wc.to_image()</span></span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.image <span class="keyword">as</span> img</span><br><span class="line"></span><br><span class="line">font = FontProperties(fname=<span class="string">'res/canger02_W03.ttf'</span>)</span><br><span class="line">print_dicts = &#123;<span class="string">'n'</span>: <span class="string">'名词'</span>, <span class="string">'nr'</span>: <span class="string">'人名'</span>, <span class="string">'ns'</span>: <span class="string">'地名'</span>&#125;</span><br><span class="line">plt.rcParams[<span class="string">'figure.dpi'</span>] = <span class="number">180</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i, key <span class="keyword">in</span> enumerate(print_dicts.keys()):</span><br><span class="line">    image = img.imread(<span class="string">'output/qu_wordcloud_'</span>+key+<span class="string">'.png'</span>)</span><br><span class="line">    plt.subplot(<span class="number">1</span>, <span class="number">3</span>, i+<span class="number">1</span>)</span><br><span class="line">    plt.imshow(image) <span class="comment"># 显示图片</span></span><br><span class="line">    plt.axis(<span class="string">'off'</span>) <span class="comment"># 不显示坐标轴</span></span><br><span class="line">    plt.title(<span class="string">'最常出现的'</span> + print_dicts[key], fontproperties=font)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/output_24_00.png" alt=""></p>
<h2 id="统计分析最大数、平均数"><a href="#统计分析最大数、平均数" class="headerlink" title="统计分析最大数、平均数"></a>统计分析最大数、平均数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">avg_sql = <span class="string">'SELECT avg(&#123;&#125;) FROM &#123;&#125;'</span></span><br><span class="line">avg_sql2 = <span class="string">'SELECT avg(cnt) FROM (SELECT count(*) as cnt FROM &#123;1&#125; GROUP BY &#123;0&#125;) as tmp '</span></span><br><span class="line">max_sql1 = <span class="string">'SELECT &#123;0&#125;, &#123;1&#125; FROM &#123;2&#125; ORDER BY &#123;0&#125; DESC LIMIT 1'</span></span><br><span class="line">max_sql2 = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT max_num, &#123;0&#125; </span></span><br><span class="line"><span class="string">FROM (</span></span><br><span class="line"><span class="string">    SELECT &#123;1&#125;, &#123;2&#125; as max_num </span></span><br><span class="line"><span class="string">    FROM &#123;3&#125; </span></span><br><span class="line"><span class="string">    ORDER BY &#123;2&#125; DESC </span></span><br><span class="line"><span class="string">    LIMIT 1</span></span><br><span class="line"><span class="string">    ) as t NATURAL JOIN &#123;4&#125;  </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">max_sql3 = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT max_num, &#123;0&#125; </span></span><br><span class="line"><span class="string">FROM (</span></span><br><span class="line"><span class="string">    SELECT &#123;1&#125;, count(*) as max_num </span></span><br><span class="line"><span class="string">    FROM &#123;2&#125; </span></span><br><span class="line"><span class="string">    GROUP BY &#123;1&#125;</span></span><br><span class="line"><span class="string">    ORDER BY max_num DESC </span></span><br><span class="line"><span class="string">    LIMIT 1</span></span><br><span class="line"><span class="string">    ) as t NATURAL JOIN &#123;3&#125;  </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">max_vote, max_vote_qu_title = db.fetch_one(</span><br><span class="line">    max_sql2.format(<span class="string">'title'</span>, <span class="string">'qid'</span>, <span class="string">'vote_num'</span>, <span class="string">'answer'</span>, <span class="string">'question'</span>))</span><br><span class="line">max_cmt, max_cmt_qu_title = db.fetch_one(</span><br><span class="line">    max_sql2.format(<span class="string">'title'</span>, <span class="string">'qid'</span>, <span class="string">'comment_num'</span>, <span class="string">'answer'</span>, <span class="string">'question'</span>))</span><br><span class="line">max_ans, max_ans_title = db.fetch_one(</span><br><span class="line">    max_sql1.format(<span class="string">'answer_count'</span>, <span class="string">'title'</span>, <span class="string">'question'</span>))</span><br><span class="line">max_flw, max_flw_title = db.fetch_one(</span><br><span class="line">    max_sql1.format(<span class="string">'follower_count'</span>, <span class="string">'title'</span>, <span class="string">'question'</span>))</span><br><span class="line">max_toc, max_toc_title = db.fetch_one(</span><br><span class="line">    max_sql3.format(<span class="string">'title'</span>, <span class="string">'tid'</span>, <span class="string">'follow_topic'</span>, <span class="string">'topic'</span>))</span><br><span class="line">max_contirbution, max_con_user = db.fetch_one(</span><br><span class="line">    max_sql2.format(<span class="string">'uname'</span>, <span class="string">'uid'</span>, <span class="string">'contribution'</span>, <span class="string">'follow_topic'</span>, <span class="string">'usr'</span>))</span><br><span class="line">max_tag, max_tag_title = db.fetch_one(</span><br><span class="line">    max_sql3.format(<span class="string">'title'</span>, <span class="string">'tid'</span>, <span class="string">'tag'</span>, <span class="string">'topic'</span>))</span><br><span class="line">max_usr_ans, max_usr_ans_name = db.fetch_one(</span><br><span class="line">    max_sql1.format(<span class="string">'answer_count'</span>, <span class="string">'uname'</span>, <span class="string">'usr'</span>))</span><br><span class="line">max_usr_flw, max_usr_flw_name = db.fetch_one(</span><br><span class="line">    max_sql1.format(<span class="string">'follower_count'</span>, <span class="string">'uname'</span>, <span class="string">'usr'</span>))</span><br><span class="line">max_usr_art, max_usr_art_name = db.fetch_one(</span><br><span class="line">    max_sql1.format(<span class="string">'articles_count'</span>, <span class="string">'uname'</span>, <span class="string">'usr'</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209135011.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">----------+---------+---------+----------------------------------------------------- </span><br><span class="line">          | avg_num | max_num |      name_of_the_max (question, topic or usr)        </span><br><span class="line">----------+---------+---------+----------------------------------------------------- </span><br><span class="line"> 答案赞同数 |   49.9  |  283059 |                 北京协和医院有多牛？                    </span><br><span class="line"> 答案评论数 |    7.4  |   23642 |      在交通工具上靠着陌生人的肩膀睡着了是怎样一种体验？      </span><br><span class="line"> 问题回答数 |   61.2  |  103795 |                有哪些让你感觉惊艳的名字？                </span><br><span class="line"> 问题关注数 |  522.3  |  569948 |             你有哪些内行人才知道的省钱诀窍？              </span><br><span class="line"> 话题关注数 |  127.5  |  167525 |                        电影                          </span><br><span class="line"> 话题问题数 |    3.2  |   33120 |                        生活                          </span><br><span class="line"> 用户回答数 |    5.5  |   30635 |                      盐选推荐                         </span><br><span class="line"> 用户关注数 |  138.1  | 7019194 |                      知乎日报                         </span><br><span class="line"> 用户文章数 |    0.4  |   41836 |                    太平洋电脑网                        </span><br><span class="line">----------+---------+---------+-----------------------------------------------------</span><br></pre></td></tr></table></figure>


<h2 id="尝试分析赞同数频率分布"><a href="#尝试分析赞同数频率分布" class="headerlink" title="尝试分析赞同数频率分布"></a>尝试分析赞同数频率分布</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">'figure.dpi'</span>] = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">sql = <span class="string">'''</span></span><br><span class="line"><span class="string">    SELECT &#123;0&#125;, count(*) as cnt</span></span><br><span class="line"><span class="string">    FROM &#123;1&#125;</span></span><br><span class="line"><span class="string">    GROUP BY &#123;0&#125;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">df = pd.read_sql(sql.format(<span class="string">'vote_num'</span>, <span class="string">'answer'</span>), con=db.conn, index_col=<span class="string">'vote_num'</span>)</span><br><span class="line">df = df[df.index &lt; <span class="number">20</span>]</span><br><span class="line">figure = df.plot(title=<span class="string">'vote_num'</span> + <span class="string">' of '</span> + <span class="string">'answer'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209135909.png" alt=""></p>
<p>符合常识</p>
<h2 id="统计时期时段和时钟时段问题答案创建的频率分布"><a href="#统计时期时段和时钟时段问题答案创建的频率分布" class="headerlink" title="统计时期时段和时钟时段问题答案创建的频率分布"></a>统计时期时段和时钟时段问题答案创建的频率分布</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sql_qu = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT from_unixtime(create_time, '%Y-%m') AS month, count(*) AS question_count</span></span><br><span class="line"><span class="string">FROM question</span></span><br><span class="line"><span class="string">GROUP BY from_unixtime(create_time, '%Y-%m')</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">sql_ans = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT from_unixtime(create_time, '%Y-%m') AS month, count(*) AS answer_count</span></span><br><span class="line"><span class="string">FROM answer</span></span><br><span class="line"><span class="string">GROUP BY from_unixtime(create_time, '%Y-%m')</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df_qu = pd.read_sql(sql_qu, db.conn, index_col=<span class="string">'month'</span>)</span><br><span class="line">df_ans = pd.read_sql(sql_ans, db.conn, index_col=<span class="string">'month'</span>)</span><br><span class="line">df = df_qu.join(df_ans, how=<span class="string">'outer'</span>).fillna(<span class="number">0</span>)</span><br><span class="line">df = df[df.index &lt; <span class="string">'2019-11'</span>]</span><br><span class="line">df.plot(title=<span class="string">'create_num per month'</span>)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br><span class="line">sql_qu = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT from_unixtime(create_time, '%H:%i') AS clock, count(*) AS question_count</span></span><br><span class="line"><span class="string">FROM question</span></span><br><span class="line"><span class="string">GROUP BY from_unixtime(create_time, '%H:%i')</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">sql_ans = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT from_unixtime(create_time, '%H:%i') AS clock, count(*) AS answer_count</span></span><br><span class="line"><span class="string">FROM answer</span></span><br><span class="line"><span class="string">GROUP BY from_unixtime(create_time, '%H:%i')</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df_qu = pd.read_sql(sql_qu, db.conn, index_col=<span class="string">'clock'</span>)</span><br><span class="line">df_ans = pd.read_sql(sql_ans, db.conn, index_col=<span class="string">'clock'</span>)</span><br><span class="line">df = df_qu.join(df_ans, how=<span class="string">'outer'</span>).fillna(<span class="number">0</span>)</span><br><span class="line">df.plot(title=<span class="string">'create_num per minute'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>


<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209135930.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209135939.png" alt=""></p>
<h2 id="统计用户性别分布"><a href="#统计用户性别分布" class="headerlink" title="统计用户性别分布"></a>统计用户性别分布</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT </span></span><br><span class="line"><span class="string">    CASE gender</span></span><br><span class="line"><span class="string">        WHEN 0 THEN 'male'</span></span><br><span class="line"><span class="string">        WHEN 1 THEN 'female'</span></span><br><span class="line"><span class="string">        WHEN -1 THEN 'unknown'</span></span><br><span class="line"><span class="string">    END as gender</span></span><br><span class="line"><span class="string">, count(*) AS num</span></span><br><span class="line"><span class="string">FROM usr</span></span><br><span class="line"><span class="string">GROUP BY gender</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df = pd.read_sql(sql, db.conn, index_col=<span class="string">'gender'</span>)</span><br><span class="line">df.plot(kind=<span class="string">'pie'</span>, title=<span class="string">'gender distribution'</span>, y=<span class="string">'num'</span>, autopct=<span class="string">'%.2f'</span>)</span><br><span class="line">plt.gca().legend_.remove()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209135949.png" style="zoom:80%;" />


<h2 id="统计男女用户关注者的性别分布"><a href="#统计男女用户关注者的性别分布" class="headerlink" title="统计男女用户关注者的性别分布"></a>统计男女用户关注者的性别分布</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT a.gender1, b.gender as gender2, count(*) as num</span></span><br><span class="line"><span class="string">FROM (</span></span><br><span class="line"><span class="string">    SELECT gender as gender1, follower</span></span><br><span class="line"><span class="string">    FROM usr NATURAL JOIN follow ) as a </span></span><br><span class="line"><span class="string">    JOIN usr as b on a.follower = b.uid</span></span><br><span class="line"><span class="string">GROUP BY gender1, gender2</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df = pd.read_sql(sql, db.conn)</span><br><span class="line">df[<span class="string">'gender2'</span>] = df[<span class="string">'gender2'</span>].apply(<span class="keyword">lambda</span> x: <span class="string">'male'</span> <span class="keyword">if</span> x == <span class="number">0</span> <span class="keyword">else</span> (<span class="string">'female'</span> <span class="keyword">if</span> x == <span class="number">1</span> <span class="keyword">else</span> <span class="string">'unknown'</span>))</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">df_male = df[df[<span class="string">'gender1'</span>] == <span class="number">0</span>][[<span class="string">'gender2'</span>, <span class="string">'num'</span>]].set_index(<span class="string">'gender2'</span>)</span><br><span class="line">df_female = df[df[<span class="string">'gender1'</span>] == <span class="number">1</span>][[<span class="string">'gender2'</span>, <span class="string">'num'</span>]].set_index(<span class="string">'gender2'</span>)</span><br><span class="line">df_male.plot(kind=<span class="string">'pie'</span>, title=<span class="string">'The distribution of man\'s follower'</span>, y=<span class="string">'num'</span>, autopct=<span class="string">'%.2f'</span>)</span><br><span class="line">plt.gca().legend_.remove()</span><br><span class="line">plt.show()</span><br><span class="line">df_female.plot(kind=<span class="string">'pie'</span>, title=<span class="string">'The distribution of woman\'s follower'</span>, y=<span class="string">'num'</span>, autopct=<span class="string">'%.2f'</span>)</span><br><span class="line">plt.gca().legend_.remove()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209140023.png" style="zoom:80%;" /><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209140032.png" style="zoom:80%;" /></p>
<h2 id="验证六度空间"><a href="#验证六度空间" class="headerlink" title="验证六度空间"></a>验证六度空间</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">'''</span></span><br><span class="line"><span class="string">SELECT * FROM follow AS a</span></span><br><span class="line"><span class="string">WHERE EXISTS (</span></span><br><span class="line"><span class="string">        SELECT * FROM follow AS b </span></span><br><span class="line"><span class="string">        WHERE a.follower = b.uid )</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">df = pd.read_sql(sql, db.conn)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line">g = nx.from_pandas_edgelist(df, source=<span class="string">'uid'</span>, target=<span class="string">'follower'</span>)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm_notebook</span><br><span class="line">count_dic = dict()</span><br><span class="line"></span><br><span class="line">i, sum = <span class="number">0</span>, g.number_of_nodes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Floyd算法快是快一点，但是内存占的忒大了点，服务崩溃了</span></span><br><span class="line"><span class="comment"># length_dic = nx.floyd_warshall(g)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> lens <span class="keyword">in</span> tqdm_notebook(nx.all_pairs_shortest_path_length(g), total=sum):</span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> lens[<span class="number">1</span>].values():</span><br><span class="line">        <span class="keyword">if</span> length <span class="keyword">not</span> <span class="keyword">in</span> count_dic:</span><br><span class="line">            count_dic[length] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            count_dic[length] += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209140404.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">autolabel</span><span class="params">(rects, xpos=<span class="string">'center'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Attach a text label above each bar in *rects*, displaying its height.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    *xpos* indicates which side to place the text w.r.t. the center of</span></span><br><span class="line"><span class="string">    the bar. It can be one of the following &#123;'center', 'right', 'left'&#125;.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    xpos = xpos.lower()  <span class="comment"># normalize the case of the parameter</span></span><br><span class="line">    ha = &#123;<span class="string">'center'</span>: <span class="string">'center'</span>, <span class="string">'right'</span>: <span class="string">'left'</span>, <span class="string">'left'</span>: <span class="string">'right'</span>&#125;</span><br><span class="line">    offset = &#123;<span class="string">'center'</span>: <span class="number">0.5</span>, <span class="string">'right'</span>: <span class="number">0.57</span>, <span class="string">'left'</span>: <span class="number">0.43</span>&#125;  <span class="comment"># x_txt = x + w*off</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> rect <span class="keyword">in</span> rects:</span><br><span class="line"></span><br><span class="line">        height = rect.get_height()</span><br><span class="line">        <span class="comment">#         print(height)</span></span><br><span class="line">        <span class="keyword">if</span> height / <span class="number">1000</span> &lt; <span class="number">0.1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        plt.text(rect.get_x() + rect.get_width() * offset[xpos], <span class="number">1.01</span> * height,</span><br><span class="line">                 <span class="string">'&#123;&#125;k'</span>.format(int(height / <span class="number">1000</span>)), ha=ha[xpos], va=<span class="string">'bottom'</span>, fontproperties=font)</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plt.figure(figsize=(<span class="number">7</span>, <span class="number">6</span>))</span><br><span class="line">fig = plt.bar(x=count_dic.keys(), height=count_dic.values())</span><br><span class="line">autolabel(fig)</span><br></pre></td></tr></table></figure>


<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191209140134.png" alt=""></p>
<p>可以看到，最短距离6以上极少极少（这里也有没有把整个网络爬完的原因），基本验证了六度空间理论，并且社交距离绝大部分为4</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

