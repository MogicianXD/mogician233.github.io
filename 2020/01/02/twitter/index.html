<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Mogician zlf">
  <!-- Open Graph Data -->
  <meta property="og:title" content="数据科学导论实验_twitter"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="Mogician的个人小站"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://yoursite.com"/>
  
    <link rel="alternate" href="/atom.xml" title="Mogician的个人小站" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Mogician的个人小站</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">数据科学导论实验_twitter</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>" target="_blank" rel="noopener">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>" target="_blank" rel="noopener">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Mogician zlf</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2020-01-02</span>
            <span class="time">20:19:15</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h1 id="基于Twitter的网络结构和社会群体演化"><a href="#基于Twitter的网络结构和社会群体演化" class="headerlink" title="基于Twitter的网络结构和社会群体演化"></a>基于Twitter的网络结构和社会群体演化</h1><blockquote>
<p>* 图片存在github图床上，请在可以连通github的网络环境中阅读，以免图片预览失效</p>
</blockquote>
<h2 id="亮点"><a href="#亮点" class="headerlink" title="亮点"></a>亮点</h2><ul>
<li>代码算法逻辑更优，尤其是图构建部分，理论上比给的范例跑的快数倍</li>
<li>绘制了桑基图，虽然（限于python开源项目）不如原论文，但也花了很多的功夫，有分析价值</li>
<li>另外，对于几个系数也有更多的考虑</li>
</ul>
<h2 id="分析及预处理"><a href="#分析及预处理" class="headerlink" title="分析及预处理"></a>分析及预处理</h2><h3 id="查看json结构"><a href="#查看json结构" class="headerlink" title="查看json结构"></a>查看json结构</h3><p>随便选一个json文件拖入浏览器，借助chrome的开发者工具查看json结构</p>
<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/image-20191127123232317.png" alt=""></p>
<p>其中，name其实不需要取，nick是唯一的且只允许英文数字下划线 (\w)，作为用户的唯一标识</p>
<h3 id="迭代取数据"><a href="#迭代取数据" class="headerlink" title="迭代取数据"></a>迭代取数据</h3><p>先取完再处理耗费内存，故通过yield建立迭代器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">extract_info</span><span class="params">(batch)</span>:</span></span><br><span class="line">    plist = batch[<span class="string">"response"</span>][<span class="string">"list"</span>]</span><br><span class="line">    <span class="keyword">for</span> post <span class="keyword">in</span> plist:</span><br><span class="line">        nick = post[<span class="string">'trackback_author_nick'</span>]</span><br><span class="line">        name = post[<span class="string">'trackback_author_name'</span>]</span><br><span class="line">        date = post[<span class="string">'trackback_date'</span>]</span><br><span class="line">        content = post[<span class="string">'content'</span>]</span><br><span class="line">        <span class="keyword">yield</span> nick, date, name, content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_infos</span><span class="params">(fplist)</span>:</span></span><br><span class="line">    f_i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> fp <span class="keyword">in</span> fplist:</span><br><span class="line">        fs = os.listdir(fp)</span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> fs:</span><br><span class="line">            <span class="keyword">with</span> open(fp+filename,encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    batch = json.load(f)</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    print(<span class="string">"&#123;&#125; is error json file"</span>.format(f))</span><br><span class="line">            <span class="keyword">for</span> info <span class="keyword">in</span> extract_info(batch):</span><br><span class="line">                <span class="keyword">yield</span> list(info)</span><br><span class="line">            f_i+= <span class="number">1</span></span><br><span class="line">    print(<span class="string">"read all &#123;&#125; files"</span>.format(f_i))</span><br></pre></td></tr></table></figure>

<h3 id="提取关系"><a href="#提取关系" class="headerlink" title="提取关系"></a>提取关系</h3><blockquote>
<p> 根据用户转发、评论关系构建网络。当用户 A 在其 content 字段中@用户 B，我们<br>认为用户 A 与用户 B 之间存在联系。</p>
</blockquote>
<p>因此需要通过正则表达式提取用户的nick</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">pattern = re.compile(<span class="string">'@(\w+)'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_at_list</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> pattern.findall(content)</span><br></pre></td></tr></table></figure>

<h3 id="时间分割"><a href="#时间分割" class="headerlink" title="时间分割"></a>时间分割</h3><p>地震时间（2011年3月11日13:46）需要统一时间格式，这里统一为时间戳</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">equake_time = datetime.datetime(<span class="number">2011</span>,<span class="number">3</span>,<span class="number">11</span>,<span class="number">13</span>,<span class="number">46</span>).timestamp()</span><br></pre></td></tr></table></figure>

<h3 id="输出csv，同时保存关系文件以便之后读取"><a href="#输出csv，同时保存关系文件以便之后读取" class="headerlink" title="输出csv，同时保存关系文件以便之后读取"></a>输出csv，同时保存关系文件以便之后读取</h3><p>注意数据清洗，通过nick+date的唯一性去重</p>
<p>还需除去@自己的，避免后面的图中出现自环</p>
<p>另外，如果@自己，info中的nick是@中的nick的小写，需要判断一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'EN'</span>, <span class="string">'JP'</span>]:</span><br><span class="line">    key_dic = &#123;&#125;</span><br><span class="line">    at_dic = &#123;<span class="string">'Pre'</span>: &#123;&#125;, <span class="string">'Post'</span>: &#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'data/'</span> + c + <span class="string">'All'</span> + <span class="string">'.csv'</span>, <span class="string">'w'</span>, newline=<span class="string">''</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f0:</span><br><span class="line">        writer = csv.writer(f0)</span><br><span class="line">        writer.writerow([<span class="string">'nick'</span>, <span class="string">'date'</span>])</span><br><span class="line">        <span class="keyword">for</span> info <span class="keyword">in</span> get_infos([<span class="string">'data/'</span> + c + <span class="string">'alljson/'</span>]):</span><br><span class="line">            ater = info[<span class="number">0</span>]</span><br><span class="line">            date = info[<span class="number">1</span>]</span><br><span class="line">            key = (ater, date)</span><br><span class="line">            <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> key_dic:</span><br><span class="line">                key_dic[key] = <span class="number">1</span></span><br><span class="line">                writer.writerow([ater, date])</span><br><span class="line">                <span class="keyword">for</span> atee <span class="keyword">in</span> get_at_list(info[<span class="number">3</span>]):</span><br><span class="line">                    atee = atee.lower()</span><br><span class="line">                    <span class="keyword">if</span> atee == ater:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    i = <span class="string">'Pre'</span> <span class="keyword">if</span> date &lt;= equake_time <span class="keyword">else</span> <span class="string">'Post'</span></span><br><span class="line">                    <span class="keyword">if</span> (ater, atee) <span class="keyword">not</span> <span class="keyword">in</span> at_dic[i]:</span><br><span class="line">                        at_dic[i][(ater, atee)] = <span class="number">0</span></span><br><span class="line">                    at_dic[i][(ater, atee)] += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'data/'</span> + c + type + <span class="string">'.csv'</span>, <span class="string">'w'</span>, newline=<span class="string">''</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f1:</span><br><span class="line">            writer = csv.writer(f1)</span><br><span class="line">            writer.writerow([<span class="string">'ater'</span>, <span class="string">'atee'</span>, <span class="string">'count'</span>])</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> at_dic[type].items():</span><br><span class="line">                writer.writerow(list(item[<span class="number">0</span>]) + [item[<span class="number">1</span>]])</span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> key_dic</span><br><span class="line"><span class="keyword">del</span> at_dic</span><br></pre></td></tr></table></figure>


<h2 id="构建网络"><a href="#构建网络" class="headerlink" title="构建网络"></a>构建网络</h2><h3 id="构建图"><a href="#构建图" class="headerlink" title="构建图"></a>构建图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm_notebook <span class="keyword">as</span> tqdm</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_graph</span><span class="params">(df: pd.DataFrame)</span>:</span></span><br><span class="line">    </span><br><span class="line">    g = nx.Graph()</span><br><span class="line">    g.add_weighted_edges_from(df.values.tolist())</span><br><span class="line">    <span class="comment"># for row in tqdm(df.iterrows(), total=len(df)):</span></span><br><span class="line">    <span class="comment">#     ater = row[1]['nick']</span></span><br><span class="line">    <span class="comment">#     for at in row[1]['atlist']:</span></span><br><span class="line">    <span class="comment">#         data = g.get_edge_data(ater, at)</span></span><br><span class="line">    <span class="comment">#         if data is None:</span></span><br><span class="line">    <span class="comment">#             g.add_edge(ater, at, weight=1)</span></span><br><span class="line">    <span class="comment">#         else:</span></span><br><span class="line">    <span class="comment">#             g[data[0]][data[1]].update(&#123;'weight': data[]&#125;)</span></span><br><span class="line">    <span class="keyword">return</span> g</span><br></pre></td></tr></table></figure>

<h3 id="删除非共有节点"><a href="#删除非共有节点" class="headerlink" title="删除非共有节点"></a>删除非共有节点</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">drop_diff_point</span><span class="params">(G1: nx.Graph, G2: nx.Graph)</span>:</span></span><br><span class="line">    nodes = list(G1.nodes())</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span>(node <span class="keyword">in</span> G2):</span><br><span class="line">            G1.remove_node(node)</span><br><span class="line">    nodes = list(G2.nodes())</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span>(node <span class="keyword">in</span> G1):</span><br><span class="line">            G2.remove_node(node)</span><br></pre></td></tr></table></figure>

<h3 id="装载入内存"><a href="#装载入内存" class="headerlink" title="装载入内存"></a>装载入内存</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dfs = &#123;<span class="string">'EN'</span>: &#123;&#125;, <span class="string">'JP'</span>: &#123;&#125;&#125;</span><br><span class="line">nets = &#123;<span class="string">'EN'</span>: &#123;&#125;, <span class="string">'JP'</span>: &#123;&#125;&#125;</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'EN'</span>, <span class="string">'JP'</span>]:</span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'All'</span>, <span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        dfs[c][type] = pd.read_csv(<span class="string">'data/'</span> + c + type + <span class="string">'.csv'</span>)</span><br><span class="line">        <span class="keyword">if</span> type != <span class="string">'All'</span>:</span><br><span class="line">            nets[c][type] = build_graph(dfs[c][type])</span><br><span class="line">    drop_diff_point(nets[c][<span class="string">'Pre'</span>], nets[c][<span class="string">'Post'</span>])</span><br></pre></td></tr></table></figure>

<h3 id="保存网络模型"><a href="#保存网络模型" class="headerlink" title="保存网络模型"></a>保存网络模型</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'EN'</span>, <span class="string">'JP'</span>]:</span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        nx.write_gml(nets[c][type], <span class="string">'data/'</span> + c + type + <span class="string">'.gml'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="相关系数计算"><a href="#相关系数计算" class="headerlink" title="相关系数计算"></a>相关系数计算</h2><h3 id="网络平均度"><a href="#网络平均度" class="headerlink" title="网络平均度"></a>网络平均度</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_deg</span><span class="params">(G)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> np.array([i[<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> nx.degree(G)]).mean()</span><br></pre></td></tr></table></figure>

<h3 id="最大连通片（最大连通分支）"><a href="#最大连通片（最大连通分支）" class="headerlink" title="最大连通片（最大连通分支）"></a>最大连通片（最大连通分支）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">largest_com</span><span class="params">(G)</span>:</span></span><br><span class="line">    largest_components = max(nx.connected_components(nx.Graph(G)), key=len)</span><br><span class="line">    <span class="keyword">return</span> len(largest_components)</span><br></pre></td></tr></table></figure>

<h3 id="平均群居系数（平均聚集系数）"><a href="#平均群居系数（平均聚集系数）" class="headerlink" title="平均群居系数（平均聚集系数）"></a>平均群居系数（平均聚集系数）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">average_clu</span><span class="params">(G)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> nx.average_clustering(G)</span><br></pre></td></tr></table></figure>

<h3 id="图直径"><a href="#图直径" class="headerlink" title="图直径"></a>图直径</h3><p>最长最短路径的长度  nx.diameter(G)</p>
<p>所有节点间平均最短路径长度  nx.average_shortest_path_length(G)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">diameter</span><span class="params">(G)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> nx.diameter</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">avg_shortest_path_len</span><span class="params">(G)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> nx.average_clustering(G)</span><br></pre></td></tr></table></figure>

<p>但是因为图并不完全联通，所以计算会报错</p>
<h3 id="个人层面度分析"><a href="#个人层面度分析" class="headerlink" title="个人层面度分析"></a>个人层面度分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_identity</span><span class="params">(axes, *line_args, **line_kwargs)</span>:</span></span><br><span class="line">    identity, = axes.plot([], [], *line_args, **line_kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(axes)</span>:</span></span><br><span class="line">        low_x, high_x = axes.get_xlim()</span><br><span class="line">        low_y, high_y = axes.get_ylim()</span><br><span class="line">        low = max(low_x, low_y)</span><br><span class="line">        high = min(high_x, high_y)</span><br><span class="line">        identity.set_data([low, high], [low, high])</span><br><span class="line">    callback(axes)</span><br><span class="line">    axes.callbacks.connect(<span class="string">'xlim_changed'</span>, callback)</span><br><span class="line">    axes.callbacks.connect(<span class="string">'ylim_changed'</span>, callback)</span><br><span class="line">    <span class="keyword">return</span> axes</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">individualdegree</span><span class="params">(G1, G2, name, ax)</span>:</span></span><br><span class="line">    nodes1 = G1.nodes()</span><br><span class="line">    nodes2 = G2.nodes()</span><br><span class="line">    degree1 = []</span><br><span class="line">    degree2 = []</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes1:</span><br><span class="line">        <span class="keyword">if</span> node <span class="keyword">in</span> nodes2:</span><br><span class="line">            degree1.append(G1.degree(node))</span><br><span class="line">            degree2.append(G2.degree(node))</span><br><span class="line">    <span class="comment"># plt.scatter(degree1,degree2)#在双对坐标轴上绘制度分布曲线</span></span><br><span class="line">    <span class="comment"># plt.subplot(121)</span></span><br><span class="line">    plt.title(name)</span><br><span class="line">    plt.xlabel(<span class="string">'before'</span>)</span><br><span class="line">    plt.ylabel(<span class="string">'after'</span>)</span><br><span class="line">    plt.loglog(degree1,degree2,<span class="string">'o'</span>, label=name)<span class="comment">#在双对坐标轴上绘制度分布曲线</span></span><br><span class="line">    add_identity(ax, ls=<span class="string">'--'</span>)</span><br></pre></td></tr></table></figure>

<h3 id="累积度分析"><a href="#累积度分析" class="headerlink" title="累积度分析"></a>累积度分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cumlutive_degree_distribution</span><span class="params">(G)</span>:</span></span><br><span class="line">    degree = []</span><br><span class="line">    k = G.degree()</span><br><span class="line">    <span class="keyword">for</span> each_node <span class="keyword">in</span> k:</span><br><span class="line">        degree.append(each_node[<span class="number">1</span>])</span><br><span class="line">    xs = degree</span><br><span class="line">    distKeys = range(min(xs), max(xs) + <span class="number">1</span>)</span><br><span class="line">    pdf = dict([(k, <span class="number">0</span>) <span class="keyword">for</span> k <span class="keyword">in</span> distKeys])</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> xs:</span><br><span class="line">        pdf[x] += <span class="number">1</span></span><br><span class="line">    pdf_temp=pdf</span><br><span class="line">    scope = range(min(pdf),max(pdf)+<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> degree <span class="keyword">in</span> scope:</span><br><span class="line">        k=degree+<span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> k&lt;=max(pdf):</span><br><span class="line">            pdf[degree]+=pdf_temp[k]</span><br><span class="line">            k+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> pdf</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#根据（图，名称，度列表，返回一个度分布图）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">draw_degree_chart</span><span class="params">(G, name, distribution, ax=None)</span>:</span></span><br><span class="line">    <span class="comment"># degree=nx.degree_histogram(G)#返回图中所有节点的度分布序列</span></span><br><span class="line">    degree = distribution</span><br><span class="line">    <span class="comment"># print(degree)</span></span><br><span class="line">    y = np.array(list(degree.values()))</span><br><span class="line">    <span class="comment"># print(y)</span></span><br><span class="line">    <span class="comment"># y=[z/float(sum(degree))for z in degree]#将频次转化为频率，利用列表内</span></span><br><span class="line">    y = y/y[<span class="number">0</span>]<span class="comment">#将频次转化为频率，利用列表内涵</span></span><br><span class="line">    x=range(len(degree))<span class="comment">#生成 X 轴序列，从 1 到最大度</span></span><br><span class="line">    <span class="keyword">if</span> ax <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        ax = plt</span><br><span class="line">    <span class="comment"># y = degree</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'e'</span> <span class="keyword">in</span> name:</span><br><span class="line">        color = <span class="string">'lightsteelblue'</span></span><br><span class="line">        marker = <span class="string">'o'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        color = <span class="string">'lightsalmon'</span></span><br><span class="line">        marker = <span class="string">'^'</span></span><br><span class="line">    line = ax.loglog(x, y, color=color, marker=marker, linestyle=<span class="string">''</span>, label=name) <span class="comment"># 在双对坐标轴上绘制度分布曲线</span></span><br></pre></td></tr></table></figure>

<h2 id="分析结果"><a href="#分析结果" class="headerlink" title="分析结果"></a>分析结果</h2><h3 id="网络基本特性信息统计对比"><a href="#网络基本特性信息统计对比" class="headerlink" title="网络基本特性信息统计对比"></a>网络基本特性信息统计对比</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable</span><br><span class="line">table = PrettyTable([<span class="string">' '</span>, <span class="string">'  '</span>, <span class="string">'#users'</span>, <span class="string">'#tweets'</span>, <span class="string">'#links'</span>, </span><br><span class="line">                     <span class="string">'#nodes'</span>, <span class="string">'avg_deg'</span>, <span class="string">'largest_com'</span>, <span class="string">'avg_clustering'</span>])</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'JP'</span>, <span class="string">'EN'</span>]:</span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        dff = dfs[c][<span class="string">'All'</span>]</span><br><span class="line">        <span class="keyword">if</span> type == <span class="string">'Pre'</span>:</span><br><span class="line">            df = dff[dff[<span class="string">'date'</span>] &lt;= equake_time]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            df = dff[dff[<span class="string">'date'</span>] &gt; equake_time]</span><br><span class="line">        n_usrs = len(df[<span class="string">'nick'</span>].unique())</span><br><span class="line">        n_tws = len(df)</span><br><span class="line">        n_links = dfs[c][type][<span class="string">'count'</span>].sum()</span><br><span class="line">        n_nodes = nets[c][type].number_of_nodes()</span><br><span class="line">        d = average_deg(nets[c][type])</span><br><span class="line">        s = largest_com(nets[c][type])</span><br><span class="line">        clu = average_clu(nets[c][type])</span><br><span class="line">        table.add_row([c, type, n_usrs, n_tws, n_links, n_nodes, round(d/<span class="number">2</span>, <span class="number">3</span>), s, round(clu/<span class="number">2</span>, <span class="number">3</span>)])</span><br><span class="line">print(table)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为是有向图，个人认为度和聚集系数不能直接按原来的无向图算，需要除以2；</p>
<p>另外，有点奇怪的是论文和老师给的模板中，user都没有去重，这里我做了一下去重</p>
</blockquote>
<pre><code>+----+------+--------+---------+--------+--------+---------+-------------+--------------+
|    |      | #users | #tweets | #links | #nodes | avg_deg | largest_com | avg_cluster  |
+----+------+--------+---------+--------+--------+---------+-------------+--------------+
| JP | Pre  |  4000  |  39347  | 25738  |  5467  |  1.602  |     4392    |     0.035    |
| JP | Post |  5383  |  102669 | 90825  |  5467  |  3.390  |     4949    |     0.045    |
| EN | Pre  |  3887  |  44124  | 29215  |  4922  |  1.338  |     4024    |     0.044    |
| EN | Post |  4436  |  57462  | 38099  |  4922  |  1.500  |     4204    |     0.048    |
+----+------+--------+---------+--------+--------+---------+-------------+--------------+</code></pre><h3 id="个人层面-度分析"><a href="#个人层面-度分析" class="headerlink" title="个人层面 度分析"></a>个人层面 度分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'JP'</span>, <span class="string">'EN'</span>]:</span><br><span class="line">    f, ax = plt.subplots(figsize=(<span class="number">6</span>,<span class="number">6</span>))</span><br><span class="line">    individualdegree(nets[c][<span class="string">'Pre'</span>], nets[c][<span class="string">'Post'</span>], c, ax)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/output_31_0.png" alt="png" style="zoom:90%;" /> <img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/output_31_1.png" alt="png" style="zoom:90%;" /></p>
<p>为了更直观地显示前后的变化，我加上了对角线。</p>
<p>个人层面上，日本地震前后 y &gt; x的更多，说明个人的度增高了，即有了更多的联系；EN则较平稳，整体的变化不大。</p>
<h3 id="累积度分析-1"><a href="#累积度分析-1" class="headerlink" title="累积度分析"></a>累积度分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'JP'</span>, <span class="string">'EN'</span>]:</span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        draw_degree_chart(nets[c][type], type, cumlutive_degree_distribution(nets[c][type]))</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.title(c)</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/output_35_0.png" alt="png" style="zoom:90%;"/>   <img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/output_35_1.png" alt="png" style="zoom:90%;" /></p>
<p>可以看到地震对美国影响不大，对日本则使累计度普遍增高。</p>
<h3 id="Dephi分析"><a href="#Dephi分析" class="headerlink" title="Dephi分析"></a>Dephi分析</h3><h4 id="网络信息统计"><a href="#网络信息统计" class="headerlink" title="网络信息统计"></a>网络信息统计</h4><p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/image-20191127214757159.png" alt=""></p>
<h4 id="社区划分与渲染"><a href="#社区划分与渲染" class="headerlink" title="社区划分与渲染"></a>社区划分与渲染</h4><p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/20191128142214.png" alt=""></p>
<h3 id="社区分析"><a href="#社区分析" class="headerlink" title="社区分析"></a>社区分析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prettytable <span class="keyword">import</span> PrettyTable</span><br><span class="line"><span class="keyword">from</span> networkx.algorithms.community <span class="keyword">import</span> k_clique_communities</span><br><span class="line"></span><br><span class="line">table = PrettyTable([<span class="string">'Region'</span>, <span class="string">'Period'</span>, <span class="string">'community_num'</span>, <span class="string">'max_com_size'</span>])</span><br><span class="line">cliques = &#123;<span class="string">'JP'</span>: &#123;<span class="string">'Pre'</span>: <span class="literal">None</span>, <span class="string">'Post'</span>: <span class="literal">None</span>&#125;, <span class="string">'EN'</span>: &#123;<span class="string">'Pre'</span>: <span class="literal">None</span>, <span class="string">'Post'</span>: <span class="literal">None</span>&#125;&#125;</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> [<span class="string">'JP'</span>, <span class="string">'EN'</span>]:</span><br><span class="line">    <span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">        clique = k_clique_communities(nets[c][type],<span class="number">4</span>)</span><br><span class="line">        clique = list(clique)</span><br><span class="line">        clique_size = [len(cl) <span class="keyword">for</span> cl <span class="keyword">in</span> clique]</span><br><span class="line">        cliques[c][type] = clique</span><br><span class="line">        table.add_row([c, type, len(clique), max(clique_size)])</span><br><span class="line">print(table)</span><br></pre></td></tr></table></figure>

<pre><code>+--------+--------+---------------+--------------+
| Region | Period | community_num | max_com_size |
+--------+--------+---------------+--------------+
|   JP   |  Pre   |       20      |     218      |
|   JP   |  Post  |       35      |     711      |
|   EN   |  Pre   |       27      |      97      |
|   EN   |  Post  |       34      |      73      |
+--------+--------+---------------+--------------+</code></pre><p>可以看到，美国的社区数增长，是正常的发展趋势；而日本的社区数减少，侧面反映了日本社交聚合关系加强；渲染图更直观地说明了这一点。</p>
<h3 id="桑基图"><a href="#桑基图" class="headerlink" title="桑基图"></a>桑基图</h3><p>又叫冲击图 Alluvial diagram，查了一下库，几乎都是R语言写的，除了一个floweaver比较不错，就用了它<br><a href="https://github.com/ricklupton/floweaver" target="_blank" rel="noopener">https://github.com/ricklupton/floweaver</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> floweaver <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ipysankeywidget <span class="keyword">import</span> SankeyWidget</span><br><span class="line"></span><br><span class="line">c = <span class="string">'JP'</span></span><br><span class="line"><span class="comment"># c = 'EN'</span></span><br><span class="line">clique_dic = &#123;<span class="string">'Pre'</span>:&#123;&#125;, <span class="string">'Post'</span>: &#123;&#125;&#125;</span><br><span class="line"><span class="keyword">for</span> type <span class="keyword">in</span> [<span class="string">'Pre'</span>, <span class="string">'Post'</span>]:</span><br><span class="line">    cliques[c][type].sort(reverse=<span class="literal">True</span>, key=len)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">20</span>):</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> cliques[c][type][i]:</span><br><span class="line">            clique_dic[type][name] = i + <span class="number">1</span></span><br><span class="line">df1 = pd.DataFrame.from_dict(clique_dic[<span class="string">'Pre'</span>], orient=<span class="string">'index'</span>, columns=[<span class="string">'source'</span>])</span><br><span class="line">df2 = pd.DataFrame.from_dict(clique_dic[<span class="string">'Post'</span>], orient=<span class="string">'index'</span>, columns=[<span class="string">'target'</span>])</span><br><span class="line">df3 = df1.join(df2, how=<span class="string">'inner'</span>).astype(<span class="string">'Int64'</span>)</span><br><span class="line">df3 = df3.reset_index()</span><br><span class="line">df3.columns = [<span class="string">'source'</span>, <span class="string">'pre'</span>, <span class="string">'post'</span>]</span><br><span class="line">df3[<span class="string">'type'</span>] = <span class="number">1</span></span><br><span class="line">df3[<span class="string">'value'</span>] = <span class="number">1</span></span><br><span class="line">df3[<span class="string">'target'</span>] = df3[<span class="string">'source'</span>]</span><br></pre></td></tr></table></figure>


<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> floweaver <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">size = dict(width=<span class="number">888</span>, height=<span class="number">666</span>)</span><br><span class="line">nodes = &#123;</span><br><span class="line">    <span class="string">'PreTop10'</span>: ProcessGroup(df3[<span class="string">'source'</span>].tolist()),</span><br><span class="line">    <span class="string">'PostTop10'</span>: ProcessGroup(df3[<span class="string">'source'</span>].tolist()),</span><br><span class="line">&#125;</span><br><span class="line">ordering = [[<span class="string">'PreTop10'</span>], [<span class="string">'PostTop10'</span>]]</span><br><span class="line">bundles = [Bundle(<span class="string">'PreTop10'</span>, <span class="string">'PostTop10'</span>),]</span><br><span class="line">sdd = SankeyDefinition(nodes, bundles, ordering)</span><br><span class="line"></span><br><span class="line">pre_partition = Partition.Simple(<span class="string">'process'</span>,</span><br><span class="line">                            [(i, df3[df3.pre==i].source.tolist()) <span class="keyword">for</span> i <span class="keyword">in</span> list(range(<span class="number">100</span>))[<span class="number">1</span>:]])</span><br><span class="line">post_partition = Partition.Simple(<span class="string">'process'</span>, </span><br><span class="line">                            [(i, df3[df3.post==i].source.tolist()) <span class="keyword">for</span> i <span class="keyword">in</span> list(range(<span class="number">100</span>))[<span class="number">1</span>:]])</span><br><span class="line">nodes[<span class="string">'PreTop10'</span>].partition = pre_partition</span><br><span class="line">nodes[<span class="string">'PostTop10'</span>].partition = post_partition</span><br><span class="line"></span><br><span class="line">weave(sdd, df3[[<span class="string">'source'</span>, <span class="string">'target'</span>, <span class="string">'type'</span>, <span class="string">'value'</span>]]).to_widget(**size)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/sangjijp.png" alt=""></p>
<p>日本的桑基图中，几乎所有社区的用户都汇集在一起，也很少有社区分散，同样可以看到社区紧密程度的提升</p>
<p><img src="https://raw.githubusercontent.com/mogician-alt/PicBed/dev/sangjien.png" alt=""></p>
<p>EN的桑基图中，社区用户的汇聚变化不如日本，从第一大社区的增幅和来源成分就可以看出；另外，EN地震后的没有出现在图中的社区大多由离散的用户（因为不构成社区所以不在左侧的来源中）组成，社区变化也较简单。</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

